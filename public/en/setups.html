<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Setups - Tennis String Advisor</title>
  <meta name="description" content="Manage your saved racquet + string + tension configurations.">
  <link rel="canonical" href="https://tennisstringadvisor.org/en/setups.html">
  <link rel="alternate" hreflang="fr" href="https://tennisstringadvisor.org/setups.html">
  <link rel="alternate" hreflang="en" href="https://tennisstringadvisor.org/en/setups.html">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/rcs-calculator.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tennis: { green: '#16a34a', dark: '#0d1117', light: '#f0fdf4' }
          }
        }
      }
    }
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YSSLHJ5WYD"></script>
  <script src="/js/analytics.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <a href="/en/" class="flex items-center gap-2">
          <span class="text-2xl">üéæ</span>
          <span class="font-bold text-xl text-gray-900">Tennis String Advisor</span>
        </a>
        <nav class="hidden md:flex items-center gap-6">
          <a href="/en/" class="text-gray-600 hover:text-green-600 transition">Home</a>
          <a href="/en/configurator.html" class="text-gray-600 hover:text-green-600 transition">Configurator</a>
          <a href="/en/racquets.html" class="text-gray-600 hover:text-green-600 transition">Racquets</a>
          <a href="/en/strings.html" class="text-gray-600 hover:text-green-600 transition">Strings</a>
          <a href="/en/rcs-calculator.html" class="text-gray-600 hover:text-green-600 transition">ü©∫ RCS</a>
          <a href="/setups.html" class="text-blue-600 hover:text-blue-700 transition">üá´üá∑ FR</a>
        </nav>
        <div class="flex items-center gap-4">
          <a href="/en/account.html" class="text-sm text-green-600 hover:underline">My Account</a>
          <button onclick="handleLogout()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition">
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
      <div>
        <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
          <a href="/en/account.html" class="hover:text-green-600">My Account</a>
          <span>‚Ä∫</span>
          <span class="text-gray-900">My Setups</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900">üéæ My Setups</h1>
        <p class="text-gray-600 mt-1">Manage your racquet + string + tension configurations</p>
      </div>
      <button onclick="openCreateModal()" id="createBtn"
        class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition shadow-lg">
        ‚ûï Create Setup
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-6">
        <div>
          <span class="text-2xl font-bold text-green-600" id="setupCount">0</span>
          <span class="text-gray-500 text-sm"> / </span>
          <span class="text-gray-500 text-sm" id="setupLimit">3</span>
          <span class="text-gray-500 text-sm ml-1">setups</span>
        </div>
        <div class="h-8 w-px bg-gray-200"></div>
        <div class="text-sm text-gray-500">
          Average RCS: <span class="font-semibold text-gray-900" id="avgRcs">--</span>
        </div>
      </div>
      <a href="/en/premium.html" class="text-sm text-amber-600 hover:underline" id="premiumLink">
        ‚≠ê Go Premium for unlimited setups
      </a>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-16">
      <div class="inline-block animate-spin text-4xl mb-4">üéæ</div>
      <p class="text-gray-600">Loading...</p>
    </div>

    <!-- Premium Required State -->
    <div id="premiumRequired" class="hidden">
      <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl border-2 border-amber-200 overflow-hidden">
        <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-8 py-6 text-center">
          <span class="text-5xl mb-4 block">‚≠ê</span>
          <h2 class="text-2xl font-bold text-white">Premium Feature</h2>
          <p class="text-amber-100 mt-2">Setup saving is reserved for Premium members</p>
        </div>
        
        <div class="p-8">
          <div class="max-w-2xl mx-auto">
            <h3 class="text-xl font-bold text-gray-900 mb-6 text-center">Why go Premium?</h3>
            
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üéæ</div>
                <div>
                  <div class="font-semibold text-gray-900">Unlimited setups</div>
                  <div class="text-sm text-gray-600">Save all your racquet + string + tension configurations</div>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üìä</div>
                <div>
                  <div class="font-semibold text-gray-900">Complete history</div>
                  <div class="text-sm text-gray-600">Track the evolution of your strings over time</div>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üîî</div>
                <div>
                  <div class="font-semibold text-gray-900">Price alerts</div>
                  <div class="text-sm text-gray-600">Get notified when your favorite products go on sale</div>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üìÑ</div>
                <div>
                  <div class="font-semibold text-gray-900">PDF export</div>
                  <div class="text-sm text-gray-600">Export your setups to share with your stringer</div>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">ü©∫</div>
                <div>
                  <div class="font-semibold text-gray-900">Advanced RCS</div>
                  <div class="text-sm text-gray-600">Detailed analysis and personalized recommendations</div>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üí¨</div>
                <div>
                  <div class="font-semibold text-gray-900">Priority support</div>
                  <div class="text-sm text-gray-600">Dedicated email assistance</div>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 border border-amber-200 text-center mb-6">
              <div class="text-sm text-gray-500 mb-1">Monthly subscription</div>
              <div class="text-4xl font-bold text-amber-600">$2.99<span class="text-lg text-gray-500 font-normal">/month</span></div>
              <div class="text-sm text-gray-500 mt-1">or $24.99/year (~30% savings)</div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <a href="/en/premium.html" class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:from-amber-600 hover:to-orange-600 transition shadow-lg">
                ‚≠ê Go Premium
              </a>
              <a href="/en/account.html" class="inline-flex items-center justify-center gap-2 px-8 py-4 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition">
                ‚Üê Back to account
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- What's free section -->
      <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
        <h3 class="font-bold text-gray-900 mb-4">‚úÖ What stays free</h3>
        <div class="grid md:grid-cols-4 gap-4">
          <a href="/en/racquets.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
            <span class="text-2xl">üéæ</span>
            <span class="text-gray-700">Racquets Catalog</span>
          </a>
          <a href="/en/strings.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
            <span class="text-2xl">üßµ</span>
            <span class="text-gray-700">Strings Catalog</span>
          </a>
          <a href="/en/rcs-calculator.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
            <span class="text-2xl">ü©∫</span>
            <span class="text-gray-700">RCS Calculator</span>
          </a>
          <a href="/en/configurator.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
            <span class="text-2xl">‚öôÔ∏è</span>
            <span class="text-gray-700">Configurator</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Premium Content (only shown to premium users) -->
    <div id="premiumContent" class="hidden">
      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-16 bg-white rounded-2xl border border-gray-200">
        <span class="text-6xl mb-4 block">üì¶</span>
        <h2 class="text-xl font-bold text-gray-900 mb-2">No saved setups</h2>
        <p class="text-gray-600 mb-6">Create your first setup to keep track of your favorite configurations.</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button onclick="openCreateModal()"
            class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition">
            ‚ûï Create Setup
          </button>
          <a href="/en/configurator.html"
            class="inline-flex items-center gap-2 px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition">
            ‚öôÔ∏è Use Configurator
          </a>
        </div>
      </div>

      <!-- Setups Grid -->
      <div id="setupsGrid" class="hidden grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <!-- Setups will be rendered here -->
      </div>
    </div>
  </main>

  <!-- Create/Edit Setup Modal -->
  <div id="setupModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-900" id="modalTitle">Create Setup</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      
      <form id="setupForm" onsubmit="handleSaveSetup(event)" class="p-6 space-y-6">
        <input type="hidden" id="setupId">
        
        <!-- Setup Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Setup name *</label>
          <input type="text" id="setupName" required maxlength="50"
            class="w-full rounded-lg border-gray-300 border p-3 focus:ring-green-500 focus:border-green-500"
            placeholder="E.g.: Clay court competition setup">
        </div>

        <!-- Racquet Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Racquet *</label>
          <select id="racquetSelect" required onchange="updateRcsPreview()"
            class="w-full rounded-lg border-gray-300 border p-3 focus:ring-green-500 focus:border-green-500">
            <option value="">Select a racquet...</option>
          </select>
          <p class="text-xs text-gray-500 mt-1" id="racquetInfo"></p>
        </div>

        <!-- String Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">String *</label>
          <select id="stringSelect" required onchange="updateRcsPreview()"
            class="w-full rounded-lg border-gray-300 border p-3 focus:ring-green-500 focus:border-green-500">
            <option value="">Select a string...</option>
          </select>
          <p class="text-xs text-gray-500 mt-1" id="stringInfo"></p>
        </div>

        <!-- Tension -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tension (kg) *</label>
          <div class="flex items-center gap-4">
            <input type="range" id="tensionSlider" min="18" max="30" value="24" step="0.5"
              class="flex-1" onchange="updateTensionDisplay(); updateRcsPreview();">
            <div class="w-20 text-center">
              <input type="number" id="tensionInput" min="18" max="30" value="24" step="0.5" required
                class="w-full rounded-lg border-gray-300 border p-2 text-center focus:ring-green-500 focus:border-green-500"
                onchange="updateSliderFromInput(); updateRcsPreview();">
              <span class="text-xs text-gray-500">kg</span>
            </div>
          </div>
        </div>

        <!-- RCS Preview -->
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-600">Estimated RCS Score</div>
              <div class="text-3xl font-bold" id="rcsPreview">--</div>
              <div class="text-sm" id="rcsLabel">Select racquet and string</div>
            </div>
            <div class="w-24 h-24 rounded-full border-8 flex items-center justify-center" id="rcsGauge"
              style="border-color: #e5e7eb;">
              <span class="text-2xl" id="rcsEmoji">‚ùì</span>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
          <textarea id="setupNotes" rows="3" maxlength="500"
            class="w-full rounded-lg border-gray-300 border p-3 focus:ring-green-500 focus:border-green-500"
            placeholder="E.g.: Ideal for hard court matches in summer..."></textarea>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-4 pt-4 border-t border-gray-200">
          <button type="submit" id="saveBtn"
            class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
            <span>üíæ Save</span>
            <span id="saveSpinner" class="hidden">‚è≥</span>
          </button>
          <button type="button" onclick="closeModal()"
            class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Affiliate Modal -->
  <div id="affiliateModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden">
      <div class="bg-gradient-to-r from-green-600 to-green-500 px-6 py-4 text-white">
        <h2 class="text-xl font-bold">üõí Where to buy?</h2>
        <p class="text-green-100 text-sm mt-1" id="affiliateProduct">Product</p>
      </div>
      <div class="p-6 space-y-4" id="affiliateLinks">
        <!-- Links will be rendered here -->
      </div>
      <div class="px-6 pb-6">
        <button onclick="closeAffiliateModal()" class="w-full py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white mt-16">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="text-center text-gray-400 text-sm">
        <p>¬© 2025 Tennis String Advisor. A brand of Pleneuf Trading LLC. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://yhhdkllbaxuhwrfpsmev.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloaGRrbGxiYXh1aHdyZnBzbWV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NjI0MDEsImV4cCI6MjA4MTMzODQwMX0.2aC_gYZf0xxz6MXi5zcaCH2S64RBaQvXU7a5qiuD0_k';
    
    let supabaseClient = null;
    try {
      if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.error('Supabase init error:', e);
    }

    let currentUser = null;
    let racquets = [];
    let strings = [];
    let userSetups = [];
    let maxSetups = 3;
    let isPremium = false;

    const AFFILIATE_CONFIG = {
      tennisWarehouse: { name: 'Tennis Warehouse', logo: 'üè¨', baseUrl: 'https://www.tennis-warehouse.com/', tag: '?from=tsa' },
      tennisPoint: { name: 'Tennis-Point', logo: 'üéæ', baseUrl: 'https://www.tennis-point.com/', tag: '?utm_source=tennisstring' },
      decathlon: { name: 'Decathlon', logo: 'üè™', baseUrl: 'https://www.decathlon.com/', tag: '?mc=affiliate_tsa' }
    };

    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        window.location.href = '/en/auth.html';
        return;
      }
      currentUser = session.user;
      await loadData();
    }

    async function loadData() {
      try {
        const { data: racquetData } = await supabaseClient.from('racquets').select('*').order('brand, model');
        racquets = racquetData || [];
        const { data: stringData } = await supabaseClient.from('strings').select('*').order('brand, model');
        strings = stringData || [];
        populateRacquetSelect();
        populateStringSelect();

        try {
          const { data: profile } = await supabaseClient.from('profiles').select('is_premium').eq('id', currentUser.id).single();
          if (profile?.is_premium) {
            isPremium = true;
            maxSetups = Infinity;
            document.getElementById('setupLimit').textContent = '‚àû';
            document.getElementById('premiumLink').classList.add('hidden');
          }
        } catch (e) {
          isPremium = localStorage.getItem('tsa_premium_demo') === 'true';
        }

        document.getElementById('loadingState').classList.add('hidden');
        
        if (!isPremium) {
          document.getElementById('premiumRequired').classList.remove('hidden');
          document.getElementById('premiumContent').classList.add('hidden');
          document.querySelector('.flex.flex-col.md\\:flex-row.md\\:items-center.justify-between')?.classList.add('hidden');
          document.querySelector('.bg-white.rounded-xl.border.border-gray-200.p-4.mb-6')?.classList.add('hidden');
          return;
        }
        
        document.getElementById('premiumRequired').classList.add('hidden');
        document.getElementById('premiumContent').classList.remove('hidden');
        await loadSetups();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="text-red-500 text-4xl mb-4">‚ùå</div>
          <p class="text-gray-600">Error loading data.</p>
          <button onclick="location.reload()" class="mt-4 text-green-600 hover:underline">Retry</button>
        `;
      }
    }

    async function loadSetups() {
      try {
        const { data: setups, error } = await supabaseClient
          .from('user_setups')
          .select('*, racquets(*), strings(*)')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        if (error) throw error;
        userSetups = setups || [];
        renderSetups();
      } catch (error) {
        userSetups = [];
        renderSetups();
      }
    }

    function renderSetups() {
      document.getElementById('setupCount').textContent = userSetups.length;
      if (userSetups.length > 0) {
        const avg = Math.round(userSetups.reduce((sum, s) => sum + (s.rcs_score || 0), 0) / userSetups.length);
        document.getElementById('avgRcs').textContent = avg || '--';
      }
      if (userSetups.length >= maxSetups && !isPremium) {
        document.getElementById('createBtn').disabled = true;
        document.getElementById('createBtn').classList.add('opacity-50', 'cursor-not-allowed');
      }
      if (userSetups.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('setupsGrid').classList.add('hidden');
        return;
      }
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('setupsGrid').classList.remove('hidden');
      document.getElementById('setupsGrid').innerHTML = userSetups.map(setup => renderSetupCard(setup)).join('');
    }

    function renderSetupCard(setup) {
      const rcsColor = setup.rcs_score < 40 ? 'green' : setup.rcs_score < 60 ? 'yellow' : setup.rcs_score < 80 ? 'orange' : 'red';
      const rcsEmoji = setup.rcs_score < 40 ? 'üíö' : setup.rcs_score < 60 ? 'üíõ' : setup.rcs_score < 80 ? 'üß°' : '‚ù§Ô∏è';
      const rcsLabel = getRcsLabel(setup.rcs_score);
      const racquet = setup.racquets || {};
      const string = setup.strings || {};

      return `
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition group">
          <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-4 py-3 flex items-center justify-between">
            <h3 class="font-bold text-white truncate">${escapeHtml(setup.name || 'Unnamed setup')}</h3>
            <div class="flex items-center gap-1">
              <button onclick="editSetup('${setup.id}')" class="p-2 text-gray-400 hover:text-white transition" title="Edit">‚úèÔ∏è</button>
              <button onclick="deleteSetup('${setup.id}')" class="p-2 text-gray-400 hover:text-red-400 transition" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
          <div class="p-4">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-lg">üéæ</div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 truncate">${racquet.brand || ''} ${racquet.model || 'Racquet'}</div>
                <div class="text-xs text-gray-500">${racquet.weight || '?'}g ‚Ä¢ RA ${racquet.stiffness || '?'}</div>
              </div>
              <button onclick="showAffiliate('racquet', ${JSON.stringify(racquet).replace(/"/g, '&quot;')})" class="text-xs text-green-600 hover:underline whitespace-nowrap">Buy ‚Üí</button>
            </div>
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-lg">üßµ</div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 truncate">${string.brand || ''} ${string.model || 'String'}</div>
                <div class="text-xs text-gray-500">${string.type || 'N/A'} ‚Ä¢ ${string.stiffness || '?'} lb/in</div>
              </div>
              <button onclick="showAffiliate('string', ${JSON.stringify(string).replace(/"/g, '&quot;')})" class="text-xs text-green-600 hover:underline whitespace-nowrap">Buy ‚Üí</button>
            </div>
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-lg">‚ö°</div>
              <div>
                <div class="font-semibold text-gray-900">${setup.tension || '?'} kg</div>
                <div class="text-xs text-gray-500">Tension</div>
              </div>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <div class="text-sm text-gray-600">RCS Score</div>
                <div class="flex items-center gap-2">
                  <span class="text-2xl font-bold" style="color: ${rcsColor === 'green' ? '#16a34a' : rcsColor === 'yellow' ? '#ca8a04' : rcsColor === 'orange' ? '#ea580c' : '#dc2626'}">${setup.rcs_score || '--'}</span>
                  <span class="text-lg">${rcsEmoji}</span>
                </div>
                <div class="text-xs text-gray-500">${rcsLabel}</div>
              </div>
              <a href="/en/rcs-calculator.html?ra=${racquet.stiffness || ''}&cordage=${string.stiffness || ''}&tension=${setup.tension || ''}" class="text-sm text-green-600 hover:underline">Details ‚Üí</a>
            </div>
            ${setup.notes ? `<div class="mt-3 p-3 bg-amber-50 rounded-lg border border-amber-100"><div class="text-xs text-amber-800">${escapeHtml(setup.notes)}</div></div>` : ''}
            <div class="mt-3 text-xs text-gray-400 text-right">Created ${new Date(setup.created_at).toLocaleDateString('en-US')}</div>
          </div>
        </div>
      `;
    }

    function getRcsLabel(score) {
      if (!score) return 'Not calculated';
      if (score < 20) return 'Ultra Comfort';
      if (score < 40) return 'Very Comfortable';
      if (score < 60) return 'Balanced';
      if (score < 80) return 'Performance';
      return 'Extreme';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function populateRacquetSelect() {
      const select = document.getElementById('racquetSelect');
      const grouped = racquets.reduce((acc, r) => { if (!acc[r.brand]) acc[r.brand] = []; acc[r.brand].push(r); return acc; }, {});
      let html = '<option value="">Select a racquet...</option>';
      Object.keys(grouped).sort().forEach(brand => {
        html += `<optgroup label="${brand}">`;
        grouped[brand].forEach(r => {
          html += `<option value="${r.id}" data-stiffness="${r.stiffness || ''}" data-weight="${r.weight || ''}">${r.model}${r.variant ? ` ${r.variant}` : ''} - RA ${r.stiffness || '?'}</option>`;
        });
        html += '</optgroup>';
      });
      select.innerHTML = html;
    }

    function populateStringSelect() {
      const select = document.getElementById('stringSelect');
      const grouped = strings.reduce((acc, s) => { if (!acc[s.brand]) acc[s.brand] = []; acc[s.brand].push(s); return acc; }, {});
      let html = '<option value="">Select a string...</option>';
      Object.keys(grouped).sort().forEach(brand => {
        html += `<optgroup label="${brand}">`;
        grouped[brand].forEach(s => {
          html += `<option value="${s.id}" data-stiffness="${s.stiffness || ''}" data-type="${s.type || ''}">${s.model} - ${s.stiffness || '?'} lb/in (${s.type || 'N/A'})</option>`;
        });
        html += '</optgroup>';
      });
      select.innerHTML = html;
    }

    function updateTensionDisplay() { document.getElementById('tensionInput').value = document.getElementById('tensionSlider').value; }
    function updateSliderFromInput() { document.getElementById('tensionSlider').value = document.getElementById('tensionInput').value; }

    function updateRcsPreview() {
      const racquetSelect = document.getElementById('racquetSelect');
      const stringSelect = document.getElementById('stringSelect');
      const tension = parseFloat(document.getElementById('tensionInput').value);
      const racquetOption = racquetSelect.options[racquetSelect.selectedIndex];
      const stringOption = stringSelect.options[stringSelect.selectedIndex];
      const ra = parseFloat(racquetOption?.dataset?.stiffness);
      const cordage = parseFloat(stringOption?.dataset?.stiffness);

      if (racquetOption?.value) {
        document.getElementById('racquetInfo').textContent = `RA: ${ra || 'N/A'}, Weight: ${racquetOption.dataset.weight || 'N/A'}g`;
      } else {
        document.getElementById('racquetInfo').textContent = '';
      }
      if (stringOption?.value) {
        document.getElementById('stringInfo').textContent = `Stiffness: ${cordage || 'N/A'} lb/in, Type: ${stringOption.dataset.type || 'N/A'}`;
      } else {
        document.getElementById('stringInfo').textContent = '';
      }

      if (ra && cordage && tension && typeof RCS !== 'undefined') {
        const score = RCS.calculate(ra, cordage, tension);
        const decile = RCS.getDecile(score);
        document.getElementById('rcsPreview').textContent = Math.round(score);
        document.getElementById('rcsLabel').textContent = decile.label;
        const gauge = document.getElementById('rcsGauge');
        const emoji = document.getElementById('rcsEmoji');
        if (score < 30) { gauge.style.borderColor = '#16a34a'; emoji.textContent = 'üíö'; }
        else if (score < 50) { gauge.style.borderColor = '#84cc16'; emoji.textContent = 'üíõ'; }
        else if (score < 70) { gauge.style.borderColor = '#eab308'; emoji.textContent = 'üß°'; }
        else if (score < 90) { gauge.style.borderColor = '#f97316'; emoji.textContent = 'üî∂'; }
        else { gauge.style.borderColor = '#dc2626'; emoji.textContent = '‚ù§Ô∏è'; }
      } else {
        document.getElementById('rcsPreview').textContent = '--';
        document.getElementById('rcsLabel').textContent = 'Select racquet and string';
        document.getElementById('rcsGauge').style.borderColor = '#e5e7eb';
        document.getElementById('rcsEmoji').textContent = '‚ùì';
      }
    }

    function openCreateModal() {
      if (userSetups.length >= maxSetups && !isPremium) {
        alert(`You have reached the limit of ${maxSetups} setups. Go Premium for more.`);
        return;
      }
      document.getElementById('modalTitle').textContent = 'Create Setup';
      document.getElementById('setupForm').reset();
      document.getElementById('setupId').value = '';
      document.getElementById('tensionInput').value = 24;
      document.getElementById('tensionSlider').value = 24;
      updateRcsPreview();
      document.getElementById('setupModal').classList.remove('hidden');
    }

    function editSetup(id) {
      const setup = userSetups.find(s => s.id === id);
      if (!setup) return;
      document.getElementById('modalTitle').textContent = 'Edit Setup';
      document.getElementById('setupId').value = setup.id;
      document.getElementById('setupName').value = setup.name || '';
      document.getElementById('racquetSelect').value = setup.racquet_id || '';
      document.getElementById('stringSelect').value = setup.string_id || '';
      document.getElementById('tensionInput').value = setup.tension || 24;
      document.getElementById('tensionSlider').value = setup.tension || 24;
      document.getElementById('setupNotes').value = setup.notes || '';
      updateRcsPreview();
      document.getElementById('setupModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('setupModal').classList.add('hidden'); }

    async function handleSaveSetup(e) {
      e.preventDefault();
      const setupId = document.getElementById('setupId').value;
      const racquetSelect = document.getElementById('racquetSelect');
      const stringSelect = document.getElementById('stringSelect');
      const racquetOption = racquetSelect.options[racquetSelect.selectedIndex];
      const stringOption = stringSelect.options[stringSelect.selectedIndex];
      const ra = parseFloat(racquetOption?.dataset?.stiffness) || 63;
      const cordage = parseFloat(stringOption?.dataset?.stiffness) || 180;
      const tension = parseFloat(document.getElementById('tensionInput').value);
      let rcsScore = null;
      if (typeof RCS !== 'undefined' && ra && cordage && tension) {
        rcsScore = Math.round(RCS.calculate(ra, cordage, tension));
      }

      const setupData = {
        user_id: currentUser.id,
        name: document.getElementById('setupName').value.trim(),
        racquet_id: document.getElementById('racquetSelect').value || null,
        string_id: document.getElementById('stringSelect').value || null,
        tension: tension,
        rcs_score: rcsScore,
        notes: document.getElementById('setupNotes').value.trim() || null,
        updated_at: new Date().toISOString()
      };

      document.getElementById('saveSpinner').classList.remove('hidden');
      document.getElementById('saveBtn').disabled = true;

      try {
        let result;
        if (setupId) {
          result = await supabaseClient.from('user_setups').update(setupData).eq('id', setupId).eq('user_id', currentUser.id).select();
        } else {
          setupData.created_at = new Date().toISOString();
          result = await supabaseClient.from('user_setups').insert(setupData).select();
        }
        if (result.error) throw result.error;
        closeModal();
        await loadSetups();
      } catch (error) {
        if (error.message.includes('relation') || error.code === '42P01') {
          alert('The user_setups table does not exist yet. Please run the SQL script in Supabase Dashboard first.');
        } else {
          alert('Error: ' + error.message);
        }
      } finally {
        document.getElementById('saveSpinner').classList.add('hidden');
        document.getElementById('saveBtn').disabled = false;
      }
    }

    async function deleteSetup(id) {
      if (!confirm('Are you sure you want to delete this setup?')) return;
      try {
        const { error } = await supabaseClient.from('user_setups').delete().eq('id', id).eq('user_id', currentUser.id);
        if (error) throw error;
        await loadSetups();
      } catch (error) {
        alert('Error deleting: ' + error.message);
      }
    }

    function showAffiliate(type, product) {
      const productName = `${product.brand || ''} ${product.model || (type === 'racquet' ? 'Racquet' : 'String')}`.trim();
      document.getElementById('affiliateProduct').textContent = productName;
      const searchQuery = encodeURIComponent(productName);
      let html = '';
      Object.entries(AFFILIATE_CONFIG).forEach(([key, config]) => {
        html += `
          <a href="${config.baseUrl}search/?q=${searchQuery}${config.tag}" target="_blank" rel="noopener noreferrer"
            class="flex items-center gap-4 p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-green-500 transition group">
            <div class="text-3xl">${config.logo}</div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 group-hover:text-green-700">${config.name}</div>
              <div class="text-sm text-gray-500">View offers ‚Üí</div>
            </div>
          </a>
        `;
      });
      document.getElementById('affiliateLinks').innerHTML = html;
      document.getElementById('affiliateModal').classList.remove('hidden');
    }

    function closeAffiliateModal() { document.getElementById('affiliateModal').classList.add('hidden'); }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      window.location.href = '/en/auth.html';
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeModal(); closeAffiliateModal(); }
    });

    checkAuth();
  </script>
</body>
</html>
